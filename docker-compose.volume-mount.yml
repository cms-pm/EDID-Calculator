# ============================================
# EDID Calculator - Production Docker Compose
# ============================================
# Deployment pattern: Pre-built images + volume mounts
# Based on .claude/deployment/examples/docker-compose.yml (WordPress pattern)
#
# Prerequisites:
#   - dokploy-network must exist (external overlay network)
#   - dist/ directory must contain built frontend (npm run build)
#   - GEMINI_API_KEY environment variable set in Dokploy
#
# Deploy:
#   docker-compose up -d

services:
  frontend:
    image: nginx:alpine
    container_name: edid-frontend
    expose:
      - "80"
    volumes:
      - ./dist:/usr/share/nginx/html:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./scripts/frontend-entrypoint.sh:/docker-entrypoint.d/99-verify-dist.sh:ro
    command: sh -c "/docker-entrypoint.d/99-verify-dist.sh"
    labels:
      - "traefik.enable=true"

      # HTTP router - redirect all HTTP to HTTPS
      - "traefik.http.routers.edid-http.rule=Host(`edid.praqsys.net`)"
      - "traefik.http.routers.edid-http.entrypoints=web"
      - "traefik.http.routers.edid-http.middlewares=edid-redirect-to-https"
      - "traefik.http.routers.edid-http.service=edid-frontend"

      # HTTPS router
      - "traefik.http.routers.edid-secure.rule=Host(`edid.praqsys.net`)"
      - "traefik.http.routers.edid-secure.entrypoints=websecure"
      - "traefik.http.routers.edid-secure.tls=true"
      - "traefik.http.routers.edid-secure.tls.certresolver=letsencrypt"
      - "traefik.http.routers.edid-secure.service=edid-frontend"

      # Service configuration
      - "traefik.http.services.edid-frontend.loadbalancer.server.port=80"

      # Middlewares (defined inline, not referencing Dokploy UI)
      - "traefik.http.middlewares.edid-redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.edid-redirect-to-https.redirectscheme.permanent=true"

    restart: unless-stopped

    healthcheck:
      # CRITICAL: Use 127.0.0.1 not localhost (DOKPLOY_LEARNINGS lesson)
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://127.0.0.1/health || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 40s  # Conservative to avoid restart loops
      retries: 3

    networks:
      - dokploy-network

  backend:
    image: python:3.11-slim
    container_name: edid-backend
    working_dir: /app

    # Install dependencies and run FastAPI
    command: sh -c "pip install --no-cache-dir -r requirements.txt && uvicorn app.main:app --host 0.0.0.0 --port 8000"

    volumes:
      - ./backend:/app:ro  # Read-only mount for security

    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}

    expose:
      - "8000"

    labels:
      - "traefik.enable=true"

      # API routes (PathPrefix /api)
      - "traefik.http.routers.edid-api.rule=Host(`edid.praqsys.net`) && PathPrefix(`/api`)"
      - "traefik.http.routers.edid-api.entrypoints=websecure"
      - "traefik.http.routers.edid-api.tls=true"
      - "traefik.http.routers.edid-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.edid-api.service=edid-backend"

      # Service configuration
      - "traefik.http.services.edid-backend.loadbalancer.server.port=8000"

    restart: unless-stopped

    healthcheck:
      # Python-based health check (curl not available in slim image)
      test: ["CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://127.0.0.1:8000/health\")' || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 40s  # Allow time for pip install
      retries: 3

    networks:
      - dokploy-network

networks:
  dokploy-network:
    external: true  # Must exist before deployment
