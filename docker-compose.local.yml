# ============================================
# EDID Calculator - Local Development Docker Compose
# ============================================
# For local development and testing
# Uses bridge network and exposed ports (no Traefik)
#
# Usage:
#   1. Copy .env.example to .env and configure
#   2. Build frontend: npm run build
#   3. Start: docker-compose -f docker-compose.local.yml up
#   4. Access: http://localhost:8080

services:
  frontend:
    image: nginx:alpine
    container_name: edid-frontend-local
    ports:
      - "8080:80"
    volumes:
      - ./dist:/usr/share/nginx/html:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://127.0.0.1/health || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3
    networks:
      - edid-local

  backend:
    image: python:3.11-slim
    container_name: edid-backend-local
    working_dir: /app

    # Use --reload for hot reload during development
    command: sh -c "pip install --no-cache-dir -r requirements.txt && uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"

    ports:
      - "8000:8000"

    volumes:
      - ./backend:/app  # Read-write for development

    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}

    restart: unless-stopped

    healthcheck:
      test: ["CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://127.0.0.1:8000/health\")' || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3

    networks:
      - edid-local

networks:
  edid-local:
    driver: bridge
